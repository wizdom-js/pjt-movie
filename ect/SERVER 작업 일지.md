## SERVER 작업 일지

#### 1117 날씨 맑음, 쌀쌀함

목표 -> 초기세팅, 모델세팅, 게시판 크루드

- community, accounts app 생성

- settings.py 설정

  ```
  INSTALLED_APP에 앱등록
  
  cors 설치후 등록, 
  pillow 설치 (media 이미지 사용 위해)
  미디어, 스태틱설정
  
  urlpattenrs = [
  	
  ] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
  
  유저모델 바꿔주기 -> accounts의 유저모델로
  ```
  
- 유저모델, 커뮤니티 모델 정의

- 마이그레이션, 마이그레이트, 테이블 확인

- #### 커밋

- serializers.py 정의 (유저, 커뮤니티)

- #### 커밋

- 게시판 보여주기위한 애들 받아오기 , 게시글 create

- #### 커밋

- 지슬&영남 협동으로  VUE에서 회원가입하여 장고로 유저 data넣는것, 토큰받아오기, 로그인까지 성공

- ![img](https://cdn.discordapp.com/attachments/872756958036365312/910553819128152126/profile_img_null.png)

```
어려웠던점: 
400 Bad request 에러가 떠서 많이 애먹었다. 이유는 user의 필드중에 추가로 설정한 profile_image필드를 처음 회원가입할 때 따로 등록을 안해서 필드가 비어서 not null constraint에러가 뜬 것. 이를 모델에서 profile_image 필드의 required 속성을 False로 설정함으로써 해결하였다! 
(똘똘지슬이가 해결함)
```

- #### 커밋

- 게시판 CRUD views.py로직 post맨으로 확인완료

```
어려웠던점:
POST 요청에서 직렬화를 하고 유효성 검사를 통과한 후, user_id 필드가 비어있다고 에러가 떴다. 이유는 직렬화 후 serializer.save()하고 괄호안에 어떤 유저가 POST요청을 보낸건지 정보를 추가로 안넣어준것. user는 post할때마다 내가보냈다! 라고 같이 요청을 보내지 않으니 serializers.py에서 user_id필드를 read_only_field로 설정하고, serializer.save(user=request.user) 이렇게 괄호안에 유저정보를 넣어주므로써 해결하였다
pf. 이전에 save(commit=False)후 추가로 데이터를 넘겨준 후 save했던 것을 좀더 쉽게하기위해 저렇게 괄호안에서 장고가 알아서 user정보를 받아오도록 내부구조가 짜여져 있다.
```

- 게시판 댓글 CRUD views.py로직 post맨으로 확인 완료

```
어려웠던점:
POST 요청을 보낼때 댓글은 유저와 게시글, 두가지의 모델을 참조한다. 그러므로 게시판의 POST처럼 save()의 인자로 유저정보와 게시글의 정보를 동시에 넘겨줘야하는데 user정보는 잘 받아오지만 게시글의 정보를 못받아와서 에러가 발생하였다. 처음에 게시글의 id를 user정보를 받아오는 것처럼 post=request.post 으로도 해보았고 post_id=request.data['post_id']로 직접 넣어보기도 했지만 모두 에러가 발생하였다.
잘 생각해보면 post_id는 url에서 넘겨받은 post_pk와 동일한 것을 잊고있었다. post_id=post_pk로 바꿔주니 문제가 해결되었다.
```

- #### 커밋

- 프론트의 편의를 위해 serializer.py수정(user_id-> user에대한 전반적인 정보를 더 제공하도록 이중으로)



#### 1118 날씨 맑음 추움

- seriallizer 게시글 정보 받아올때 그 게시글에달린 댓글의 정보까지 모두 보여주도록 수정

```
Vue에서 게시글에대한 요청을 한번 보내고 그 게시글의 id를 하위 컴포넌트로 프롭시켜서 그 id를 이용하여 요청을 한번 더 보내서 할 생각이였으나 이러면 요청을 두번 보내야 되기 때문에 한번의 요청으로 끝내기 위해 수정하였다. (프론트의 편의와 불필요한 요청 제거를 위해)
```

- #### 커밋

```
1117 마지막에 serializer 이슈, axios 요청을 한번만으로 하기위해 했으나 댓글, 게시글을 쓴 후 바로 화면에 반영시키기위해서 axios 두번 쓰는건 불가피하다라고 판단.
```

- community에서 댓글, 게시글 받아올 때, 나중에 쓴 글이 위로 가도록 정렬하도록

```
어려웠던점
게시글은 그냥 모두 받아와서 뒤집으면 되므로 posts = Post.objects.order_by('-pk') 하나로 끝난다.
하지만 댓글은 해당 게시글의 댓글만 받아오면 되므로
comments = get_list_or_404(Comment, post_id=post_pk)
comments.sort(key=lambda x: x.pk, reverse=True)
처음엔 이렇게 먼저 필터링을 한후 정렬하는 것으로 대안을 세웠다

하지만 지(니어)슬의 아이디어로
comments = get_list_or_404(Comment.objects.order_by('-pk'), post_id=post_pk)
이렇게 바꿀 수 있었다.
이코드가 더 좋은이유: 처음부터 pk역순으로 차곡차곡 쌓으므로, 쪼끔 더 빠르다
```



- 팔로우, 팔로워 1102 워크샵 참고하여 follow 기능 구현,

- 프로필 페이지 유저 전체정보 받아오기, follow 완료(게시글 좋아요 정보 serializer에 담는건 아직)

- ### 커밋

- 모델 수정

  movie_review, movie_like 가 보이는것처럼 M,N관계가 되있는게 아니라 그냥 따로 모델로 user만 참조하는 건데 movie api로 받아온 movie_id만 따로 넣어준것
  
  일단 지금은 ERD만 바꿨다.

![image-20211119011028676](SERVER 작업 일지.assets/image-20211119011028676.png)

- 내 팔로워 목록에서 팔로우 끊어버리기

- 게시글 좋아요

- ### 커밋

#### 1119 날씨 맑음 쌀쌀함

- movie app 생성, 등록, 모델정의

- 영화 detail넘겨주는 함수 완료.

- ### 커밋

- tmdb로 api요청보내서 받을 수 있는 경로들 추가

- 임상실험 후 크롤링 데이터 db에 넣기 성공.

```
1. 엑셀파일 csv파일로 만들기. (한글 안깨지게 메모장으로 켜서 UTF-8로 인코딩하면서 저장)
2. 모델은 csv파일과 동일하게, (필드이름, 속성)
3. movie_id를 primary key로

sqlite3 db.sqlite3
.mode csv
.import tmdb.csv movie_crawledmovie
```

- ### 커밋

- profileserializer에 쓴 게시물수, 댓글수 반영

- ### 커밋

- post 시리얼라이저에 좋아요한 유저들 수 반영

- 프로필에 좋아요한 게시글 수 반영

- 게시글 좋아요, 좋아요 취소 url 만듬

- 디테일에서 좋아요 여부 같이 보내기

- 영화검색 url

- ### 커밋

- 영화detail에서 유저가 좋아요 한 상태인지 아닌지 알 수 있게 함.

- 게시글디테일에서 유저가 좋아요 한 상태인지 아닌지 알 수 있게 함. (좋아요 개수 확인 가능)

```
어려웠던점:
게시글 마다 유저가 좋아요 한 상태인지 아닌지를 알기 위해서는 is_liked라는 속성이 필요한데 초기 모델에는 그 속성을 추가하지 않아서 어떻게 이 정보를 알리지 애먹었는데 모델을 수정하니 해결되었다.
이문제로 몇시간 고민한 내가 싫다.
```

- 프로필에 좋아요한 영화들 목록 (이름, 포스터까지 같이 보내기) 성공
- 위 과정을 하면서 모델 수정 (movie_like에 poster path 추가, community_post에 is_liked추가)

### 1120 맑음 쌀쌀함

- 게시글 받아오기, 생성 url 분리, 댓글 받아오기 생성 url 분리,

- 리뷰 받아오기, 작성, 수정, 삭제 기능 추가

- ### 커밋

댓글, 리뷰 등을 마지막까지 삭제하면 404에러가 뜸 -> 이유는 get_list_or_404를 썼기때문

- 위의 에러가 의도되지 않은 get_list_or_404를 모두 Class.objects.~~~ 으로 바꾸어주었다.

- 게시글 검색

- 모델 수정, 리뷰 모델의 title속성 제거(리뷰는 제목이 없는게 더 낫다고 판단)

- ### 커밋

- 닉네임 속성에 unique=True추가

- 회원정보 수정 추가(닉네임, 프로필이미지, )

- 비밀번호 변경 url추가( db에서 변경한 비밀번호를 해싱후 기존 비밀번호와 바꿔치기 )

```
비밀번호 변경
client: 로컬 저장소에서 기존 jwt 삭제, 새 jwt발급후 로컬에 넣기
server: 새비밀번호를 해싱후 DB에 업데이트
```

- ### 커밋

- 회원탈퇴 (db에서삭제)

- ### 커밋

- 모델 변경(Review에 영화제목, 포스터패스 추가), 프로필정보 받아올때 이메일까지 받아오게

- 프로필에 내가 작성한 리뷰와 그 개수 나타나게

- ### 커밋

- 모델 추가 (탈퇴사유 모델만들어서 관리자가 사이트에대한 피드백가능하도록)

- 회원 탈퇴시 받아온 feedback 데이터를 모델에 추가하도록 함

- 관리자 페이지 추가

- ### 커밋

### 1121 추움, 구름 조금

- 회원가입시 유저가 좋아하는 장르 기반 영화좋아요 하기 위해 영화리스트들 넘겨주는 url(signup_like) 추가

- 페이지네이션

- ### 커밋

- user 모델에 location 추가(default는 서울) -> 날씨api에 활용하기위해 -> 프론트에서도 나타나게

- Feedback 모델에 reason필드 추가

- 날씨추천 추가

- ### 커밋

- location을 회원정보수정에도 반영.

- 날씨 추천 개선

```
SF878, TV 영화10770, 가족10751, 공포27, 다큐멘터리99, 드라마18, 로맨스10749, 모험12, 미스터리9648, 범죄80, 서부37, 스릴러53, 애니메이션16, 액션28, 역사36, 음악10402, 판타지14, 전쟁10752, 코미디35

날씨 API 키 openweathermap
9b2fdd2bd99c6b378a098370ee54ef51

Thunderstorm(뇌우) - 뭔가 격한거: SF 공포 범죄 스릴러 전쟁 (랜덤 돌려)
Drizzle(보슬비) - 감성: 드라마 애니메이션 음악 판타지
Rain(비) - 무서운거 or 감성: 공포 범죄 스릴러 음악 드라마
Snow(눈) - 감성, 동심: 로맨스 애니메이션 음악 코미디 가족
Atmosphere(안개, 먼지, 돌풍) - 격한거: SF 범죄 스릴러 서부 전쟁
Clear(맑음) - 밝은거: SF 드라마 로맨스 애니메이션 액션 음악 판타지 가족 코미디
Clouds(구름) - 우울: 공포 범죄 스릴러 전쟁 미스터리
```

- ### 커밋

- signup할 때 seriliarizer에 location 추가

- 날씨추천 데이터 유지보수 편하게 개선, 시간대에 따른 영화 추천( 새벽 아침 점심 저녁 밤 )

- ### 커밋

- 로케이션필드삭제, 프론트에서 받아온 위도, 경도에 따라 날씨 알수 있게 수정

- 이미지 업로드를 위한 모델 수정(유저모델의 프로필 이미지)

- ### 커밋

- 이미지 업로드 경로 수정, delete 메소드 오버라이딩 수정

#### 1122 구름

```
오늘의 일기
날씨추천 데이터 안받아와짐 -> GET->  POST.
```

- 영남's 알고리즘 추가!
- 알림창
  - 댓글 공백 입력시 "댓글을 입력해주세요."
  - 게시글 입력시 알림창 띄우기
  - 비밀번호 변경버튼 누를시 비밀번호 비어있으면 알림, 비밀번호 달라도 알림
  - 회원정보 수정페이지 비밀번호 입력안하고 확인시 (isUser)
  - 영화 검색창 빈값시 -> 지슬이가 바꾸기로함
  - 영화 리뷰 빈값 등록시
  - 회원 탈퇴 isUser 확인시

- 나중에할일

  - app.vue에 검색바에 넣기

    

```
feedback 혹시 도움 될까봐
네브바 메뉴들 왼쪽구석에 정렬
플레이스 홀더 다나오게
폰트는 통일하는게 좋음

보드검색창과 영화검색창 디자인 서로 바꾸는게 좋음 (영화검색창이 밑줄)
보드검색창은 create옆으로 옮기기
게시판에서 BOARD 가운데에 놓고 아래여백 좀더
표에 지금 위랑 아래랑 border:2px solid #000으로 똑같이 들어가있는데 위를 약간 더 두껍게 주기
number 아래 있는 td는 가운데 정렬
```

- 회원탈퇴 사유

```
서비스 불만
개인정보 유출 우려
사이트 이용 빈도 낮음
지구 온난화 방지를 위한 PC사용 자제
회원간의 트러블
재 가입을 위해서
```

- 탈퇴기능 추가

- 관리자 기능 추가

- ### 커밋

```
날씨추천이슈 지슬이한테 토스..
```

- 시간대별 추천 넣음

- 리뷰기반추천 넣음

- ### 커밋

- 리뷰기반추천 개선(알고리즘 개선 total타고내려오면서 장르 국가를 따로 저장, 무비를 저장하는게 아니라)

- 댓글에서 유저 누르면 프로필로 이동하게

- ### 커밋

- top rated movie 백드롭패스 없는거 거르기, 백드롭패스로 모두 바꿈 

- similar movie 포스터 없는거 거르기

- now movie 포스터 없는거 거르기

- recommend movie 포스터 없는거 거르기

- review movie 포스터 없는거 거르기

- weather movie 백드롭 없는거 거르기, 백드롭으로 바꾸기

- 좋아요기반 영화추천 추천페이지에서접근시, 디테일에서 접근시 백드롭, 포스터로 나오게 설정

```
리뷰 무비는 크롤링 데이터를 쓰는데 거기에 백드롭패스가 없으므로 지슬이가 나중에 데이터 다시받기로 함.
```

- - 간단하게 말해서 포스터들 리뷰무비추천빼고 전부 원하는대로 나오게함

- ### 커밋

- 프로필 페이지에 리뷰 나오게함

- ### 커밋

- 프로필 비밀번호 변경 알럿 잘뜨게함.

  리뷰기반추천 수정
  
  게시글 생성, 수정페이지 꾸밈, 게시글 디테일에서 줄바꿈 적용, 게이글 좋아요 이슈 해결(Post 모델에서 is_liked필드 삭제), tmdb데이터 모델에 backdrop_path추가된걸로 업데이트, 리뷰기반추천 백드롭으로 변경, 성인영화 열람페이지 꾸밈

해야할것

프로필 세팅 페이지

비밀번호 변경시 비밀번호 확인 후 새 비밀번호로 바로 오토포커스 되게 하는거 해야된다.

```
1. Tell us What you want (TU WYW) 투와이
2. Get What You Want (과이)
3. Get Ready With Me
4. move it!
5. 영챠 영남 + 왓챠
6. 뭅 이건 솔직 3번이랑 같은맥락
7. 영화원
8. 무비다방
9. 지플릭스

발표자료 피드백 (공포영화 너무 많이추천해줘요)

시간남으면 회원찾기

회원정보`

레이아웃 초점
```

